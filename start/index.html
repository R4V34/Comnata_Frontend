<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
	<title>Comnata</title>
	<link rel="stylesheet" href="main.css">
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.form/4.3.0/jquery.form.min.js" integrity="sha384-qlmct0AOBiA2VPZkMY3+2WqkHtIQ9lSdAsAn5RUJD/3vA5MKDgSGcdmIv4ycVxyn" crossorigin="anonymous"></script>

    <script>
    	var loc = window.location.href + '';
		if (loc.indexOf('http://') == 0){
    		window.location.href = loc.replace('http://','https://');
		}
    </script>
    
</head>

<body bgcolor="#262c38">
    <form id="myForm" action="https://e5969482adea.ngrok.io/video/upload" enctype="multipart/form-data" method="POST">
        <input id="input__file" name="file" type="file" hidden onchange="downloadFile()">
        <input id="ok_boss" type="submit" hidden>
    </form>

    <div id="main_area">
	    <div id="mid_text">ИЛИ</div>
        <div class="input__wrapper">
            <div id="button_load">
                <div id="button_load_text">Выберите файл</div>
                <label for="input__file" id="download_label"></label>
            </div>
        </div>
        <div id="start_button">
            <div id="button_load_text">LET'S COMNATA</div>
            <label for="ok_boss" id="download_label"></label>
        </div>
	    <input id="textarea" placeholder="Введите код доступа..." rows="1" onchange="tryStartRoom()"></input>
        <div id="line_"></div>
	</div>
    <h1 id="bottom_text">COMNATA</h1>


	<link rel="preconnect" href="https://fonts.gstatic.com">
	<link href="https://fonts.googleapis.com/css2?family=Lexend:wght@500&family=Montserrat:wght@600&display=swap" rel="stylesheet">

    <!-- button_.innerHTML -->
	<script>
        $('#myForm').ajaxForm({
            url : "https://e5969482adea.ngrok.io/video/upload",
            success : function (response) {
                localStorage.setItem("link", response["videoId"]);
                localStorage.setItem("videoUrl", response["videoUrl"]);
                document.location = '../main_player/';
            }
        })
;
//{"status":"SUCCESS","videoId":"68665525b9f24209b607b18863e62d21","videoUrl":"/video/getVideo/68665525b9f24209b607b18863e62d21/video.m3u8"}

		var loc = window.location.href + '';
        if (loc.indexOf('http://') == 0){
            window.location.href = loc.replace('http://','https://');
        }

            var video_length = 0; 
            function downloadFile()
            {
                var input = document.getElementById("input__file");
                var textarea = document.getElementById("textarea");
                if (input.files.length > 0){
                    var but = document.getElementById("start_button");
                    video_length = input.files[0].size;
                    but.style.display = "inline-table";
                    textarea.value = input.files[0].name;
                    console.log(video_length);
                }
            }

            function tryStartRoom()
            {
                var button_ = document.getElementById("button_load");
                var link = document.getElementById("textarea").value;
                var input = document.getElementById("input__file");
                var textarea = document.getElementById("textarea");
                if (link.indexOf("youtube.com/watch") != -1)
                {
                    localStorage.setItem('comnata_link_youtube', rightLink('v=', link));
                    document.location = '../youtube_player/';
                }
                else if (link.indexOf("https://www.youtube.com/embed") == 0)
                {
                    localStorage.setItem('comnata_link_youtube', link);
                    document.location = '../youtube_player/';
                }
                else if (link.indexOf("youtu.be") != -1)
                {
                    localStorage.setItem('comnata_link_youtube', rightLink('e/', link));
                    document.location = '../youtube_player/';
                }
                else if (input.files.length > 0)
                {
                    var formData = new FormData();
                    formData.set("video", input.files[0], input.files[0].name);
                    console.log(formData);
                    var xhr = new XMLHttpRequest();
                    xhr.open("POST", "https://8962cea9de76.ngrok.io/video/upload");
                    xhr.send(formData);
                }
            }

            function rightLink(e, link)
            {
            	link = link + '&';
            	var n = link.indexOf(e) + e.length;
            	var rigth_link = '';
            	while (link.charAt(n) != '&')
            	{
            		rigth_link = rigth_link + link.charAt(n);
            		n += 1;
            	}
            	return 'https://www.youtube.com/embed/' + rigth_link;
            }

    </script>
</body>
</html>